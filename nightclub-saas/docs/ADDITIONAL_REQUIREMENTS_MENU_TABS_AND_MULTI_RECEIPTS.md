# 追加要件: メニュー登録/削除タブと複数伝票操作の拡張

目的: 既存UI/計算/CSV仕様を維持しつつ、以下を実装する。
- メニュー管理画面に「登録」「削除」タブを追加（登録=作成/編集、有効切替は現状踏襲、削除=個別削除/一括削除）。
- 伝票管理タブで複数の伝票をチェック選択し、一覧画面から一括操作（キャンセル/割引/決済変更/選択CSV）を実行できるようにする（既存機能を受入基準に沿って仕上げる）。

必須方針
- 最小差分で根本原因を修正/追加。既存の型・計算ロジック・デザインを踏襲。
- 実装は `nightclub-saas/src/**` のみに限定。命名/スタイル/テストは本リポ規約に準拠。

---

## 対象画面とファイル
- メニュー管理: `src/app/settings/menu/page.tsx`
- 伝票管理: `src/app/receipts/page.tsx`
- サーバーアクション: `src/server/actions/menu.ts`, `src/server/actions/receipts.ts`
- モック保存層: `src/lib/mock.ts`
- 型: `src/lib/types.ts`

---

## ユースケース（要約）
- メニュー登録タブ: 新規メニューの作成、既存メニューの編集、有効/無効切替。
- メニュー削除タブ: メニューの個別削除/一括削除。使用中でも伝票は崩れない（伝票はメニューID参照でなくスナップショットのため）。
- 伝票管理（一覧）: 複数の伝票をチェック選択し、一括でキャンセル/割引/決済方法変更/選択CSV出力を実行。選択状態・件数表示・結果トースト通知。

---

## 画面仕様

### メニュー管理 `/settings/menu`
- タブ構成: shadcn Tabs を使用。
  - 登録タブ: 既存の「一覧 + 追加/編集モーダル + 有効/無効トグル」を保持。
  - 削除タブ: テーブルにチェックボックス列を追加し、上部ツールバーに「選択削除」ボタン。行末に個別削除ボタンも配置。
- バリデーション: zod（名称必須、税込価格>=0、カテゴリー必須）。
- 削除UX: 確認ダイアログを表示。「削除は取り消せません」を明示。成功/失敗件数をトーストで通知。

UI部品例
- `Tabs/TabsList/TabsTrigger/TabsContent`
- `Table/Checkbox/Button/Dialog/AlertDialog/Badge/Switch`

アクセシビリティ/状態
- 非Activeのメニューも削除対象に含める。
- 登録タブの既存UI/レイアウトを破壊しないこと（初期表示は「登録」）。

### 伝票管理 `/receipts`
- 既存の「新規作成」「一覧」タブ構成を踏襲。
- 一覧タブの要件（既に実装済みだが受入基準で仕上げる）
  - チェックボックス列・全選択・件数表示。
  - バッチ操作: 一括キャンセル/一括割引（固定額）/一括決済変更/選択CSV出力。
  - 実行結果: 成功/失敗件数をトーストで通知。部分成功を許容。
  - 選択可能条件: `status === "active"` のみ選択可能。キャンセル済は不可。

---

## API/サーバーアクション

### メニュー
- 追加: `deleteMenuItem(id: string): Promise<{ id: string }>` を新設。
- 既存: `listMenu`, `createMenuItem`, `updateMenuItem`, `toggleMenuActive` は現状踏襲。
- バリデーション: zod スキーマに変更なし。削除はID存在チェックのみ。

mock層（`src/lib/mock.ts`）
- `mockMenuStore.delete(id: string)` を追加。該当IDが無ければエラー。成功時は要素削除。
- 伝票側に影響はない（伝票はメニューIDを保持せず、明細のスナップショットを保持）。

### 伝票（参考）
- 既存の `batchReceipts(ops)` を使用（create/update/cancel）。必要に応じてUIから `UpdateReceiptInput` を組み立てる。

---

## 型
- 変更なし（`MenuItem`/`BatchReceiptOp` は既存を使用）。
- 必要に応じて UI 内部用の軽量型を追加してもよいが、`types.ts` は最小変更ポリシー。

---

## 操作フロー（削除タブ）
1) チェックボックスで複数選択 → ツールバー「選択削除」。
2) 確認ダイアログで件数表示 → 実行。
3) `deleteMenuItem` を選択件数分直列/並列で実行し、成功/失敗件数を集計してトースト表示。
4) 一覧を再取得。
5) 個別行にも「削除」ボタンを配置（同確認/同処理）。

---

## 受入れ基準（Acceptance Criteria）
- メニュー登録タブ: 追加/編集/有効切替が動作し、バリデーション/トーストが適切に表示される。
- メニュー削除タブ: 個別/一括削除が可能。確認ダイアログあり。削除後に一覧が更新される。
- 伝票一覧タブ: 複数選択→一括操作（キャンセル/割引/決済変更/選択CSV）が成功/部分失敗を通知。キャンセル済は選択不可。
- 計算/CSV: 合計・内税の計算およびCSVの合計が既存ロジックと一致（四捨五入/切り上げ仕様を遵守）。
- UI/テーマ: 既存のワインレッド×ゴールドテーマ、shadcn/ui コンポーネントスタイルに合致。

---

## 実装詳細（変更点の指示）

### 1) mock 層
- `src/lib/mock.ts`
  - `mockMenuStore` に `delete(id: string): Promise<{ id: string }>` を追加。

### 2) サーバーアクション
- `src/server/actions/menu.ts`
  - `export async function deleteMenuItem(id: string)` を追加。
  - 404相当: 見つからない場合は `throw new Error("メニューが見つかりません")`。

### 3) メニュー画面
- `src/app/settings/menu/page.tsx`
  - ルートを Tabs 化（`value="create"|"delete"`）。
  - create タブ: 既存UI（一覧 + 追加/編集 + 有効切替）をそのまま配置。
  - delete タブ: 一覧テーブル（名称/カテゴリ/価格/状態/選択チェック/操作） + ツールバー「選択削除」。行末に個別削除ボタン。`AlertDialog` で確認。
  - フック: 削除実行中はボタンをloading状態にし、多重実行を防止。

### 4) 伝票画面
- `src/app/receipts/page.tsx`
  - 既存のタブ/チェックボックス/バッチダイアログを踏襲。エラー時のトースト、部分成功時の件数表示を確認/補強。
  - CSVは「選択された伝票のみ」を出力（既存実装を維持）。

---

## テスト（Vitest + Testing Library）
- ユニット
  - `src/server/menu.actions.test.ts`: delete 正常/異常（存在しないID）。list → delete → list で件数が減ること。
  - `src/server/receipts.actions.test.ts`: batch の成功/部分失敗（不正ID含む）を検証（既存に追加ケースがあれば追記）。
- コンポーネント
  - `src/app/settings/menu/page.test.tsx` 追加可: タブ切替/削除ダイアログ/トースト発火をモックして検証。
  - `src/app/receipts/page.test.tsx` 追加可: 複数選択→一括操作UIの有効/無効制御。
- コマンド
  - `npx vitest run`（CI） / `npx vitest`（watch）

---

## 非機能/UX
- 操作は即時反映（list再取得）。
- 失敗件数>0の場合も成功分は反映（部分成功許容）。
- 破壊的変更を避け、既存の導線/デザインから乖離しない。

---

## 影響範囲
- メニュー関連: mock層/サーバーアクション/UIの削除追加。
- 伝票関連: UIのバッチ操作のメッセージ/活性制御のみ。
- 計算/CSV/型: 変更なし。

---

## 実装順序
1. mock に delete を追加 → 単体テスト
2. `deleteMenuItem` を追加 → 単体テスト
3. `/settings/menu` を Tabs 化し、削除タブと一括削除を実装
4. `/receipts` 一覧タブのバッチ操作UIの文言/トースト/活性制御を最終調整
5. 動作確認: `npm run dev` → 主要フローを手動確認
6. `npx vitest run` でテスト合格

---

## 検証手順（PR用）
- メニュー
  - 登録タブで新規追加→一覧に反映。
  - 登録タブで編集/有効切替→一覧に反映。
  - 削除タブで行選択→選択削除→件数トースト→一覧から消える。
  - 個別削除ボタンでも同様に削除できる。
- 伝票
  - 一覧タブで複数選択→一括キャンセル/割引/決済変更/選択CSV出力が動作。キャンセル済は選択不可。
  - 合計/CSVが画面の数値と一致。

備考
- 将来DB移行時は `mockMenuStore` を repository/Prisma に置換し、API契約は維持。
- この追加は既存 `CLAUDE_TASKS_BATCH_MENU.md` の方針と両立する。
